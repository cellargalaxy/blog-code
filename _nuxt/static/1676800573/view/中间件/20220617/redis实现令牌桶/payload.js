__NUXT_JSONP__("/view/中间件/20220617/redis实现令牌桶", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,$,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al,am,an){return {data:[{siteConfig:{siteName:M,siteHost:"https:\u002F\u002Fcellargalaxy.github.io",basePath:"\u002Fblog-code\u002F",navs:[{text:"文章",url:"\u002Fblog-code\u002Fpage\u002F1\u002F"},{text:"归档",url:"\u002Fblog-code\u002Farchive\u002F0\u002F"},{text:"画画",url:"\u002Fblog-code\u002Fhtml\u002Fhua.html"},{text:"开源",url:"\u002Fblog-code\u002Fhttps:\u002Fgithub.com\u002Fcellargalaxy\u002Fblog-vue"}],pageSize:10,urlReplace:{"^/file/blog/code":"https:\u002F\u002Foracleamd1.dynv6.net\u002Ffile\u002Ffile\u002Fblog\u002Fcode"},backgroundImage:{duration:N,fade:1000,images:[{url:"https:\u002F\u002Fi.loli.net\u002F2020\u002F01\u002F25\u002FcofTzDQXitjeVZ6.jpg",description:O,type:s},{url:"https:\u002F\u002Fi.loli.net\u002F2020\u002F01\u002F25\u002FsfaRJ2lVeM3NDbE.jpg",description:O,type:s},{url:"https:\u002F\u002Fi.loli.net\u002F2020\u002F01\u002F26\u002FKybiTdftam5Su7x.jpg",description:"青春猪头-双葉理央",type:s},{url:"https:\u002F\u002Fi.loli.net\u002F2020\u002F09\u002F08\u002FxdX73nfs24qgOYk.jpg",description:"京吹-明日香,久美子",type:s},{url:"https:\u002F\u002Fi.loli.net\u002F2020\u002F02\u002F14\u002FMAiruNcEFW2HYtg.jpg",description:"终将成为你-七海灯子,小糸侑",type:s},{url:"https:\u002F\u002Fi.loli.net\u002F2020\u002F02\u002F05\u002FEojdAxTDJsFpbPw.jpg",description:"玉子市场-北白川玉子",type:s},{url:"https:\u002F\u002Fi.loli.net\u002F2020\u002F01\u002F31\u002FAXxwJDRS9fmN2uU.jpg",description:"fate_hf-弓道馆",type:s},{url:"https:\u002F\u002Fi.loli.net\u002F2020\u002F02\u002F01\u002FaHhVObpJus6dnM4.jpg",description:"fate_hf-樱花树",type:s}]}},homeConfig:{brandInterval:N,brands:[{imageUrl:"https:\u002F\u002Fi.loli.net\u002F2020\u002F01\u002F21\u002FmMEAnwY5XPC2pFb.jpg",title:"日常",texts:["我们所度过的每个平凡的日常，也许就是连续不断发生的奇迹。","日々、私たちが過ごしている日常は、実は奇跡の連続なのかもしれない。"]},{imageUrl:"https:\u002F\u002Fi.loli.net\u002F2020\u002F04\u002F19\u002FH1MmXb9xPcYEhT2.jpg",title:"昨日之歌",texts:["时间梭梭箭如飞，人道漫漫步蹒跚","人間そんな変わるもんじゃないのに、月日ばっかどんどん過ぎて"]}],navs:[{text:"Github",url:"https:\u002F\u002Fgithub.com\u002Fcellargalaxy\u002F"}]},pageFootConfig:{lines:[[{text:"Copyright © 2017-? ."},{text:"备案？不存在的"},{text:"Powered by Nuxt.js & Github"}]]},buildTime:new Date(1676800582477),siteName:M,file:{slug:P,toc:[],body:{type:"root",children:[{type:b,tag:Q,props:{},children:[{type:a,value:"记录一下最近用到了令牌桶来限频。在网上所说的令牌桶的基础上，还有一个很有用的做法。\n是允许一定程度的透支未来的令牌，但取得透支令牌的请求需要sleep一段时间。如果sleep的时间超过了能接受的上限，还是会被频率。\n这样子在sleep的时间范围内，其实起到了削峰填谷的作用。对于一些会一波一波来的请求，能起到平滑的作用。"}]},{type:a,value:i},{type:b,tag:Q,props:{},children:[{type:a,value:"下面就直接贴lua脚本"}]},{type:a,value:i},{type:b,tag:R,props:{className:[S]},children:[{type:b,tag:T,props:{className:[U,"language-text"]},children:[{type:b,tag:V,props:{},children:[{type:a,value:"\u002F\u002F      限频的key\nkeys = [\"qps_limit_xxx\"]\n\u002F\u002F      所取走的令牌数  当前时间，毫秒  最大等待时间，毫秒  令牌桶容量  周期，毫秒\nargs = [1,            now.ts(),    \"3s\".ts(),        100,      1000] \u002F\u002F也就是QPS限制为100\nwait_time = eval(\"lua_script\", keys, args)\n"}]}]}]},{type:a,value:i},{type:b,tag:R,props:{className:[S]},children:[{type:b,tag:T,props:{className:[U,"language-lua"]},children:[{type:b,tag:V,props:{},children:[{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:" key "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:" KEYS"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:t}]},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:C}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:u}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 限频的key"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:W},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:v}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:t}]},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:C}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:u}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 所取走的令牌数"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:" curr_time "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:v}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:t}]},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:X}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:u}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 当前时间，毫秒"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:Y},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:v}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:t}]},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:"3"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:u}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 最大等待时间，毫秒"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:D},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:v}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:t}]},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:"4"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:u}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 令牌桶容量"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:Z},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:v}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:t}]},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:"5"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:u}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 周期，毫秒。即假若桶是空的，经过一个周期，桶就能被填满"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:" rate "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:D},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:_}]},{type:a,value:Z},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 速率，每毫秒生成的令牌数量"}]},{type:a,value:z},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- key的数据结构是hash，如有，保存着上次取令牌的时间和剩余令牌数"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:" limit "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:" redis"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:A}]},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:"\"HMGET\""}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:F},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:G}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:H}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:" last_time "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:v}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:t}]},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:C}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:u}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:aa}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:I}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:ab},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:v}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:t}]},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:X}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:u}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:aa}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:I}]},{type:a,value:z},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 计算当前令牌数量"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:ac},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:" math"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:A}]},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:"floor"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:"curr_time"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:x}]},{type:a,value:"last_time"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:"*"}]},{type:a,value:"rate"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 上次取令牌到现在为止，新增了多少令牌"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:y},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:ab},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:"+"}]},{type:a,value:ac},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 现在桶里有多少令牌"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:J}]},{type:a,value:D},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ad}]},{type:a,value:y},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:K}]},{type:a,value:ae},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:" bucket_cap\n"},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:L}]},{type:a,value:z},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 延迟时间判断"}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:l}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,p]},children:[{type:a,value:I}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:J}]},{type:a,value:W},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:"\u003C="}]},{type:a,value:y},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:K}]},{type:a,value:B},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 如果当前桶里牌数大于要取走的牌数，直接取就好"}]},{type:a,value:ae},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:y},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:x}]},{type:a,value:" consume_permit\n    redis"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:A}]},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:F},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:H}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:ah},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:G}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:aj}]},{type:a,value:"\n    wait_time "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:"consume_permit"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:x}]},{type:a,value:"total_permit"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:_}]},{type:a,value:"rate "},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 需要多久才能生成这些透支的令牌"}]},{type:a,value:B},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:J}]},{type:a,value:Y},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ad}]},{type:a,value:af},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:K}]},{type:a,value:"\n        wait_time "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:x}]},{type:a,value:"wait_time "},{type:b,tag:c,props:{className:[d,k]},children:[{type:a,value:"-- 返回\u003C0，代表超出延迟时间，被拦截"}]},{type:a,value:B},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:aj}]},{type:a,value:"\n        total_permit "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:j}]},{type:a,value:y},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:x}]},{type:a,value:" consume_permit\n        redis"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:A}]},{type:b,tag:c,props:{className:[d,q]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:ag}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:F},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:H}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:ah},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:h},{type:b,tag:c,props:{className:[d,r]},children:[{type:a,value:G}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:o}]},{type:a,value:ai},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:B},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:L}]},{type:a,value:i},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:L}]},{type:a,value:z},{type:b,tag:c,props:{className:[d,g]},children:[{type:a,value:"return"}]},{type:a,value:" wait_time\n"}]}]}]}]},dir:ak,path:"\u002F中间件\u002F20220617\u002Fredis实现令牌桶",extension:".md",createdAt:al,updatedAt:al,excerpt:am,title:P,url:"\u002Fblog-code\u002Fview\u002F中间件\u002F20220617\u002Fredis实现令牌桶\u002F",createAt:new Date(1676800455866),updateAt:new Date(1676800455866),attributes:[{name:"createAt",value:an},{name:"updateAt",value:an},{name:"sort",value:ak,url:"\u002Fblog-code\u002Fpage\u002F中间件\u002F20220617\u002F1\u002F"}]}}],fetch:{},mutations:am}}("text","element","span","token","punctuation","operator","keyword"," ","\n","=","comment","local","(",")",",","number","function","string","wide","[","]","tonumber","ARGV","-"," total_permit ","\n\n",".","\n    ","1"," bucket_cap ","pcall"," key","\"last_time\"","\"curr_permit\"","0","if","then","end","无名の窝",10000,"青春猪头-牧之原翔子-江之岛","redis实现令牌桶","p","div","nuxt-content-highlight","pre","line-numbers","code"," consume_permit ","2"," max_wait "," period ","\u002F","limit","or"," curr_permit "," new_permit ","\u003C","\n    total_permit "," wait_time ","\"HMSET\""," total_permit"," curr_time","else","\u002F中间件\u002F20220617","2023-02-19T09:54:15.866Z",void 0,"2023-02-19")));