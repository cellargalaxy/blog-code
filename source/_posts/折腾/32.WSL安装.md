## 系统

+ 还得是安装win11，有好的好特性win10没有，垃圾微软
+ 专业版太占用内存了，现在能找到的官方最精简版本就是物联网企业版
+ 系统语言不要切换为中文，不然输入法之类的额外软件多占用半G内存
+ 也不要为了节省内存停止「服务」里的服务，不然容易导致兼容性问题
+ 开启远程，方便操作
+ WSL默认没安装防火墙，win的防火墙都关了吧，方便访问

## 安装SSHServer

```shell
# 查看server与client的安装情况
Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH*'

# 进行安装
Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

# 启动服务
Start-Service sshd
# 开机自启
Set-Service -Name sshd -StartupType 'Automatic'
```

## 禁止休眠

```shell
# 好像没有效果，得在系统设置里修改休眠配置
powercfg.exe /hibernate off
```

## win显卡驱动

WindowsUpdate自动下载那个就有用了，英伟达官网下载的版本虽然新，但是会附带GUI软件，增加资源占用

下载地址：https://www.nvidia.cn/geforce/drivers/

+ `Notebook`是笔记本版本，无`Notebook`是桌面版
+ 选择`GeForce Game Ready`的最新版本就行，不是`NVIDIA Studio`
+ 安装完还给我偷偷把`nvidia-app`给安装上了，卸载卸载

```shell
# 检测版本
nvidia-smi.exe
```

## 安装WSL

```shell
# 使用powershell启用Hyper-V
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All

# 下载WSL安装包
# https://github.com/microsoft/WSL/releases
wsl --update
wsl --version
wsl --set-default-version 2

# 安装Ubuntu-22.04，如果下载的可以到官网下载安装包
# https://learn.microsoft.com/zh-cn/windows/wsl/install-manual
wsl --install Ubuntu-22.04
wsl --shutdown

wsl --export Ubuntu-22.04 D:\wsl\ubuntu22.tar
wsl --unregister Ubuntu-22.04
wsl --import ubuntu22 D:\wsl\ubuntu22 D:\wsl\ubuntu22.tar --version 2
wsl --set-default ubuntu22
```

### WSL配置

+ 搜索：wsl settings
+ 网络模式：mirrored
+ 启用localhost转发：true
+ 本地地址回环：true
+ VM空闲超时：-1

## WSL软件配置

```shell
# 中科大源
sudo cp /etc/apt/sources.list /etc/apt/sources.list.back
sudo sed -i 's@//.*archive.ubuntu.com@//mirrors.ustc.edu.cn@g' /etc/apt/sources.list
sudo apt-get update
```

```shell
# 开放SSH
sudo apt install -y openssh-server
sudo systemctl enable ssh
sudo systemctl start ssh

# 修改ssh端口，win的ssh占用了22端口
sudo vim /etc/ssh/sshd_config
Port 123456
sudo systemctl restart sshd
```

```shell
#我这使用zsh
sudo apt install -y zsh
sh -c "$(curl -fsSL https://install.ohmyz.sh/)"

#改zsh主题
vim ~/.zshrc
ZSH_THEME="gentoo"
source ~/.zshrc
```

```shell
# 官方源的nvtop不可用
sudo add-apt-repository ppa:quentiumyt/nvtop
sudo apt install -y nvtop htop vim curl wget git
```

```shell
# 下载下来的ubuntu就自带驱动
# 但ssh远程，好像没有将下面的路径配到环境变量里
ln -s /usr/lib/wsl/lib/nvidia-smi /usr/bin/nvidia-smi
nvidia-smi
```

## WSL里安装docker

```shell
# 安装 Docker 所需的依赖项
sudo apt install apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release

# 添加 Docker 的官方 GPG 密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
# 设置 Docker 的稳定版仓库
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt install docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo systemctl enable docker
sudo systemctl start docker

# docker拉取镜像走代理，https://neucrack.com/p/286
sudo systemctl status docker                            # 查询docker的service文件路径，添加在[Service]下
Environment="HTTP_PROXY=http://192.168.123.1:10808"
Environment="HTTPS_PROXY=http://192.168.123.1:10808"
Environment="NO_PROXY=192.168.123.1"
sudo systemctl daemon-reload                            # 重载service文件

sudo mkdir /etc/docker
sudo vim /etc/docker/daemon.json
{
  "log-driver":"json-file",
  "log-opts": {"max-size":"5m", "max-file":"3"}
}
sudo systemctl restart docker # 重启docker生效配置
sudo docker info              # 检查配置是否生效

sudo groupadd docker          # 创建docker用户组
sudo gpasswd -a $USER docker  # 将用户加入到docker用户组
newgrp docker                 # 更新用户组
docker run --rm hello-world   # 检查docker能否正常运行
```

## docker链接显卡驱动

```shell
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
  && curl -s -L https://mirrors.ustc.edu.cn/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://nvidia.github.io#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://mirrors.ustc.edu.cn#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
sudo apt update
sudo apt install -y nvidia-container-toolkit

sudo nvidia-ctk runtime configure --runtime=docker                                  # 配置docker运行时
sudo systemctl restart docker                                                       # 重启docker
cat /etc/docker/daemon.json                                                         # 检测docker配置
docker run --rm --gpus all nvidia/cuda:12.9.1-cudnn-devel-ubuntu22.04 nvidia-smi # 验证
docker run --rm --gpus all nvidia/cuda:12.9.1-cudnn-devel-ubuntu22.04 nvcc -V    # 验证
docker run --rm --gpus all nvidia/cuda:12.9.1-cudnn-devel-ubuntu22.04 dpkg -l | grep libcudnn
```


## 参考

+ https://cloud.tencent.com/developer/article/2463531



